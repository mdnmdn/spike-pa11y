<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pa11y-go-wrapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-2 sm:p-4">
        <h1 class="text-2xl sm:text-3xl font-bold mb-4">pa11y-go-wrapper</h1>

        <!-- Tabs -->
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4">
                <button @click="mainTab = 'analysis'" :class="{ 'border-b-2 border-blue-500 text-blue-600': mainTab === 'analysis' }" class="py-2 px-4 text-center font-medium hover:text-blue-500 focus:outline-none">
                    Analysis
                </button>
                <button @click="mainTab = 'discovery'" :class="{ 'border-b-2 border-blue-500 text-blue-600': mainTab === 'discovery' }" class="py-2 px-4 text-center font-medium hover:text-blue-500 focus:outline-none">
                    Site Discovery
                </button>
            </nav>
        </div>

        <!-- Analysis Tab Content -->
        <div v-show="mainTab === 'analysis'">
            <!-- Direct Analysis -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-4">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Direct Analysis</h2>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <input v-model="directUrl" type="text" placeholder="https://example.com" class="flex-grow p-2 border rounded-md text-sm sm:text-base">
                    <select v-model="runner" class="p-2 border rounded-md text-sm sm:text-base">
                        <option value="htmlcs">htmlcs</option>
                        <option value="axe">axe</option>
                    </select>
                    <button @click="analyzeUrl" :disabled="directAnalyzing" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 disabled:opacity-50 text-sm sm:text-base whitespace-nowrap">Analyze</button>
                </div>
            </div>

        <!-- Enqueue URL -->
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-4">
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Enqueue URL</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <input v-model="enqueueUrl" type="text" placeholder="https://example.com" class="flex-grow p-2 border rounded-md text-sm sm:text-base">
                <select v-model="enqueueRunner" class="p-2 border rounded-md text-sm sm:text-base">
                    <option value="htmlcs">htmlcs</option>
                    <option value="axe">axe</option>
                </select>
                <button @click="enqueueSingleUrl" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 text-sm sm:text-base whitespace-nowrap">Enqueue</button>
            </div>
        </div>

        <!-- Queue -->
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-4">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
                <h2 class="text-xl sm:text-2xl font-bold">Queue</h2>
                <button @click="getQueue" class="bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600 text-sm sm:text-base">Refresh</button>
            </div>
            
            <!-- Filters -->
            <div class="mb-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                    <select v-model="statusFilter" class="w-full p-2 border rounded-md">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter by URL:</label>
                    <input v-model="urlFilter" type="text" placeholder="Filter by URL..." class="w-full p-2 border rounded-md">
                </div>
            </div>
            
            <!-- Responsive Table Container -->
            <div class="overflow-x-auto">
                <table class="w-full text-left table-auto min-w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">URL</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hidden sm:table-cell">Runner</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">Status</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hidden md:table-cell">Duration</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hidden lg:table-cell">Size</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hidden md:table-cell">Created At</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">Actions</th>
                            <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700 hidden sm:table-cell">Reports</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="item in filteredQueue" :key="item.id" class="border-t hover:bg-gray-50">
                            <td class="px-2 sm:px-4 py-2">
                                <div class="max-w-xs truncate" :title="item.url">
                                    <span class="text-xs sm:text-sm">{{ item.url }}</span>
                                </div>
                                <!-- Mobile-only info -->
                                <div class="sm:hidden text-xs text-gray-500 mt-1">
                                    <span class="inline-block mr-2">{{ item.runner || 'htmlcs' }}</span>
                                    <span v-if="item.durationMs" class="inline-block mr-2">{{ formatDuration(item.durationMs) }}</span>
                                    <span>{{ new Date(item.createdAt).toLocaleDateString() }}</span>
                                </div>
                            </td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden sm:table-cell">{{ item.runner || 'htmlcs' }}</td>
                            <td class="px-2 sm:px-4 py-2">
                                <span :class="statusBadgeClass(item.status)" class="px-1 sm:px-2 py-1 rounded text-xs font-semibold">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden md:table-cell">{{ item.durationMs ? formatDuration(item.durationMs) : '-' }}</td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden lg:table-cell">{{ item.sizeBytes ? formatBytes(item.sizeBytes) : '-' }}</td>
                            <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden md:table-cell">{{ new Date(item.createdAt).toLocaleString() }}</td>
                            <td class="px-2 sm:px-4 py-2">
                                <button @click="getQueueItem(item.id)" class="bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600 text-xs sm:text-sm">
                                    <span class="hidden sm:inline">View</span>
                                    <span class="sm:hidden">üëÅ</span>
                                </button>
                            </td>
                            <td class="px-2 sm:px-4 py-2 hidden sm:table-cell">
                                <div v-if="item.status === 'completed'" class="space-x-1">
                                    <a :href="'/api/completed/html?id=' + item.id" target="_blank" class="bg-blue-500 text-white px-1 sm:px-2 py-1 rounded-md hover:bg-blue-600 text-xs">
                                        HTML
                                    </a>
                                    <a :href="'/api/completed/pdf?id=' + item.id" target="_blank" class="bg-red-500 text-white px-1 sm:px-2 py-1 rounded-md hover:bg-red-600 text-xs">
                                        PDF
                                    </a>
                                </div>
                                <!-- Mobile reports shown in action column -->
                                <div v-if="item.status === 'completed'" class="sm:hidden mt-1 space-x-1">
                                    <a :href="'/api/completed/html?id=' + item.id" target="_blank" class="bg-blue-500 text-white px-1 py-1 rounded text-xs">
                                        üìÑ
                                    </a>
                                    <a :href="'/api/completed/pdf?id=' + item.id" target="_blank" class="bg-red-500 text-white px-1 py-1 rounded text-xs">
                                        üìã
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        </div>

        <!-- Site Discovery Tab Content -->
        <div v-show="mainTab === 'discovery'">
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-4">
                <h2 class="text-xl sm:text-2xl font-bold mb-4">Site Discovery</h2>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                    <input v-model="discoveryUrl" type="text" placeholder="https://example.com" class="flex-grow p-2 border rounded-md text-sm sm:text-base">
                    <input v-model="siteCategory" type="text" placeholder="e.g., e-commerce, blog" class="flex-grow p-2 border rounded-md text-sm sm:text-base">
                    <button @click="discoverSite" :disabled="discovering" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 disabled:opacity-50 text-sm sm:text-base whitespace-nowrap">Explore</button>
                </div>

                <div v-if="discovering" class="flex items-center text-blue-600 mb-4">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                    </svg>
                    <span class="ml-2 text-sm sm:text-base">Discovering...</span>
                </div>

                <div v-if="discoveryResults.length > 0">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <button @click="selectAll" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm">Select/Deselect All</button>
                        </div>
                        <button @click="enqueueSelected" class="bg-green-500 text-white p-2 rounded-md hover:bg-green-600 text-sm sm:text-base">Enqueue Selected</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-auto min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700"><input type="checkbox" @change="selectAll" v-model="isAllSelected"></th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">URL</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">Category</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-700">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(item, index) in discoveryResults" :key="index" class="border-t hover:bg-gray-50">
                                    <td class="px-2 sm:px-4 py-2"><input type="checkbox" v-model="item.selected" :disabled="!isStatusOk(item.status)"></td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm truncate" :title="item.url">{{ item.url }}</td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm">{{ item.category }}</td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm">{{ item.status }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div v-if="discoveryError" class="text-red-500 mt-4">
                    {{ discoveryError }}
                </div>
            </div>
        </div>

        <!-- Result -->
        <div v-if="result" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
            <h2 class="text-xl sm:text-2xl font-bold mb-4">Analysis Result</h2>

            <!-- Loader for direct analyze -->
            <div v-if="directAnalyzing && (result.status === 'pending' || result.status === 'processing')" class="flex items-center text-blue-600 mb-4">
                <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span class="ml-2 text-sm sm:text-base">Analyzing... ({{ result.status }})</span>
            </div>

            <!-- Tabs -->
            <div class="border-b mb-4">
                <nav class="flex space-x-2 sm:space-x-4">
                    <button @click="activeTab = 'results'" :class="activeTab === 'results' ? 'border-b-2 border-blue-600 text-blue-600 pb-2' : 'text-gray-600 pb-2'" class="px-1 sm:px-2 text-sm sm:text-base">Results</button>
                    <button @click="activeTab = 'raw'" :class="activeTab === 'raw' ? 'border-b-2 border-blue-600 text-blue-600 pb-2' : 'text-gray-600 pb-2'" class="px-1 sm:px-2 text-sm sm:text-base">Raw</button>
                </nav>
            </div>

            <!-- Results Tab -->
            <div v-show="activeTab === 'results'">
                <!-- Error message display when failed -->
                <div v-if="result.status === 'failed' && result.errorMessage" class="mb-4">
                    <h3 class="text-lg sm:text-xl font-bold mb-2 text-red-700">Error</h3>
                    <pre class="bg-red-50 border border-red-200 text-red-800 p-3 rounded overflow-x-auto whitespace-pre-wrap text-xs sm:text-sm">{{ result.errorMessage }}</pre>
                </div>
                <!-- Metadata -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4 mb-4 text-sm sm:text-base">
                    <div class="hidden"><span class="font-semibold">ID:</span> {{ result.id }}</div>
                    <div><span class="font-semibold">URL:</span> <span class="break-all">{{ result.url }}</span></div>
                    <div><span class="font-semibold">Runner:</span> {{ result.runner || 'htmlcs' }}</div>
                    <div><span class="font-semibold">Status:</span> <span :class="statusBadgeClass(result.status)" class="px-2 py-1 rounded text-xs font-semibold">{{ result.status }}</span></div>
                    <div><span class="font-semibold">Duration:</span> {{ result.durationMs ? formatDuration(result.durationMs) : '-' }}</div>
                    <div><span class="font-semibold">Size:</span> {{ result.sizeBytes ? formatBytes(result.sizeBytes) : '-' }}</div>
                    <div><span class="font-semibold">Created At:</span> <span class="text-xs sm:text-sm">{{ result.createdAt ? new Date(result.createdAt).toLocaleString() : '-' }}</span></div>
                    <div><span class="font-semibold">Updated At:</span> <span class="text-xs sm:text-sm">{{ result.updatedAt ? new Date(result.updatedAt).toLocaleString() : '-' }}</span></div>
                </div>

                <!-- Issues Table -->
                <div>
                    <h3 class="text-lg sm:text-xl font-bold mb-2">Issues</h3>
                    <div v-if="!result.result || result.result.length === 0" class="text-green-700 text-sm sm:text-base">No issues found.</div>
                    <div v-else class="overflow-x-auto">
                        <table class="w-full text-left table-auto min-w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium">Code</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium">Message</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium hidden md:table-cell">Type</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium hidden lg:table-cell">Type Code</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium hidden sm:table-cell">Selector</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium hidden md:table-cell">Context</th>
                                    <th class="px-2 sm:px-4 py-2 text-xs sm:text-sm font-medium hidden lg:table-cell">Runner</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(issue, idx) in result.result" :key="idx" class="border-t">
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm">
                                        <div class="max-w-xs truncate" :title="issue.code">{{ issue.code }}</div>
                                    </td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm">
                                        <div class="max-w-xs sm:max-w-sm" :title="issue.message">{{ issue.message }}</div>
                                        <!-- Mobile-only additional info -->
                                        <div class="md:hidden text-xs text-gray-500 mt-1">
                                            <span v-if="issue.type" class="inline-block mr-2">{{ issue.type }}</span>
                                            <span v-if="issue.selector" class="inline-block">{{ issue.selector }}</span>
                                        </div>
                                    </td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden md:table-cell">{{ issue.type }}</td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden lg:table-cell">{{ issue.typeCode }}</td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden sm:table-cell">
                                        <div class="max-w-xs truncate" :title="issue.selector">{{ issue.selector }}</div>
                                    </td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden md:table-cell">
                                        <div class="max-w-xs truncate" :title="issue.context">{{ issue.context }}</div>
                                    </td>
                                    <td class="px-2 sm:px-4 py-2 text-xs sm:text-sm hidden lg:table-cell">{{ issue.runner }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Raw Tab -->
            <div v-show="activeTab === 'raw'">
                <pre class="bg-gray-200 p-2 sm:p-4 rounded-md overflow-x-auto text-xs sm:text-sm"><code>{{ JSON.stringify(result, null, 2) }}</code></pre>
            </div>

            <div v-if="result.status === 'completed'" class="mt-4">
                <h3 class="text-lg sm:text-xl font-bold mb-2">Reports</h3>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <a :href="'/api/completed/html?id=' + result.id" target="_blank" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600 text-center text-sm sm:text-base">View HTML Report</a>
                    <a :href="'/api/completed/pdf?id=' + result.id" target="_blank" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 text-center text-sm sm:text-base">View PDF Report</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                mainTab: 'analysis', // 'analysis' or 'discovery'
                directUrl: '',
                runner: 'htmlcs',
                enqueueUrl: '',
                enqueueRunner: 'htmlcs',
                queue: [],
                result: null,
                directAnalyzing: false,
                activeTab: 'results',
                pollTimer: null,
                statusFilter: '',
                urlFilter: '',
                discoveryUrl: '',
                siteCategory: '',
                discovering: false,
                discoveryResults: [],
                discoveryError: '',
                isAllSelected: false,
            },
            computed: {
                filteredQueue() {
                    let filtered = [...this.queue];
                    
                    // Sort by createdAt in descending order (most recent first)
                    filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // Filter by status
                    if (this.statusFilter) {
                        filtered = filtered.filter(item => item.status === this.statusFilter);
                    }
                    
                    // Filter by URL
                    if (this.urlFilter) {
                        const urlFilterLower = this.urlFilter.toLowerCase();
                        filtered = filtered.filter(item => 
                            item.url.toLowerCase().includes(urlFilterLower)
                        );
                    }
                    
                    return filtered;
                }
            },
            methods: {
                async discoverSite() {
                    if (!this.discoveryUrl) return;
                    this.discovering = true;
                    this.discoveryResults = [];
                    this.discoveryError = '';
                    try {
                        const normalizedUrl = this.normalizeUrl(this.discoveryUrl);
                        const response = await fetch('/api/discover', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: normalizedUrl, siteCategory: this.siteCategory }),
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Failed to discover site');
                        }
                        const results = await response.json();
                        this.discoveryResults = results.map(item => ({ ...item, selected: this.isStatusOk(item.status) }));
                    } catch (error) {
                        this.discoveryError = error.message;
                    } finally {
                        this.discovering = false;
                    }
                },
                isStatusOk(status) {
                    return status.startsWith('200');
                },
                selectAll() {
                    this.isAllSelected = !this.isAllSelected;
                    this.discoveryResults.forEach(item => {
                        if (this.isStatusOk(item.status)) {
                            item.selected = this.isAllSelected;
                        }
                    });
                },
                async enqueueSelected() {
                    const selectedUrls = this.discoveryResults
                        .filter(item => item.selected)
                        .map(item => item.url);

                    if (selectedUrls.length === 0) return;

                    for (const url of selectedUrls) {
                        await this.enqueue(url, 'htmlcs');
                    }
                    this.getQueue();
                },
                normalizeUrl(url) {
                    if (!url) return url;
                    // Check if URL already has a protocol
                    if (!/^https?:\/\//i.test(url)) {
                        // Add https:// prefix for raw domain names
                        return 'https://' + url;
                    }
                    return url;
                },
                async analyzeUrl() {
                    if (!this.directUrl) return;
                    try {
                        // stop any previous polling
                        this.stopPolling();
                        this.directAnalyzing = true;
                        this.activeTab = 'results';
                        const normalizedUrl = this.normalizeUrl(this.directUrl);
                        const response = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: normalizedUrl, runner: this.runner }),
                        });
                        const analysis = await response.json();
                        this.result = analysis;
                        if (analysis && analysis.id) {
                            this.startPolling(analysis.id);
                        } else {
                            this.directAnalyzing = false;
                        }
                    } catch (error) {
                        console.error('Error analyzing URL:', error);
                        this.result = { error: 'Failed to analyze URL' };
                        this.directAnalyzing = false;
                    }
                },
                async enqueueSingleUrl() {
                    if (!this.enqueueUrl) return;
                    await this.enqueue(this.enqueueUrl, this.enqueueRunner);
                    this.enqueueUrl = '';
                    this.getQueue();
                },
                async enqueue(url, runner) {
                    try {
                        const normalizedUrl = this.normalizeUrl(url);
                        const response = await fetch('/api/queue', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: normalizedUrl, runner: runner }),
                        });
                        const newItem = await response.json();
                        this.queue.push(newItem);
                    } catch (error) {
                        console.error('Error enqueuing URL:', error);
                    }
                },
                async getQueue() {
                    try {
                        const response = await fetch('/api/queue');
                        this.queue = await response.json();
                    } catch (error) {
                        console.error('Error getting queue:', error);
                    }
                },
                async getQueueItem(id) {
                    try {
                        const response = await fetch(`/api/queue/${id}`);
                        this.result = await response.json();
                        this.activeTab = 'results';
                        this.directAnalyzing = false;
                    } catch (error) {
                        console.error('Error getting queue item:', error);
                        this.result = { error: 'Failed to get queue item' };
                    }
                },
                startPolling(id) {
                    this.stopPolling();
                    this.pollTimer = setInterval(async () => {
                        try {
                            const res = await fetch(`/api/queue/${id}`);
                            const data = await res.json();
                            this.result = data;
                            if (data.status === 'completed' || data.status === 'failed') {
                                this.stopPolling();
                                this.directAnalyzing = false;
                            }
                        } catch (e) {
                            console.error('Polling error:', e);
                            this.stopPolling();
                            this.directAnalyzing = false;
                        }
                    }, 1500);
                },
                stopPolling() {
                    if (this.pollTimer) {
                        clearInterval(this.pollTimer);
                        this.pollTimer = null;
                    }
                },
                formatBytes(bytes) {
                    if (bytes == null) return '-';
                    const thresh = 1024;
                    if (bytes < thresh) return bytes + ' B';
                    const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
                    let u = -1;
                    let val = bytes;
                    do {
                        val /= thresh;
                        ++u;
                    } while (val >= thresh && u < units.length - 1);
                    const fixed = val >= 10 ? val.toFixed(0) : val.toFixed(1);
                    return fixed + units[u].toLowerCase();
                },
                formatDuration(ms) {
                    // Simple human-readable formatter
                    if (ms == null) return '-';
                    const s = Math.floor(ms / 1000);
                    const msR = ms % 1000;
                    const h = Math.floor(s / 3600);
                    const m = Math.floor((s % 3600) / 60);
                    const sec = s % 60;
                    const parts = [];
                    if (h) parts.push(h + 'h');
                    if (m) parts.push(m + 'm');
                    if (sec || (!h && !m)) parts.push(sec + 's');
                    if (!h && !m && ms < 1000) parts.push(msR + 'ms');
                    return parts.join(' ');
                },
                statusBadgeClass(status) {
                    switch (status) {
                        case 'completed':
                            return 'bg-green-100 text-green-800';
                        case 'failed':
                        case 'error':
                            return 'bg-red-100 text-red-800';
                        case 'processing':
                            return 'bg-yellow-100 text-yellow-800';
                        case 'pending':
                        default:
                            return 'bg-gray-100 text-gray-800';
                    }
                }
            },
            mounted() {
                this.getQueue();
            }
        });
    </script>
</body>
</html>
